{{ define "header-styles" }}
<style>
    #map {
        height: 550px;
        width: 75%;
        margin: auto;
    }
</style>
{{ end}}

{{ define "main" }}

<div class="jumbotron text-center">
    <h1 class="display-4">Welcome to TATK Network!</h1>
    <p class="lead">TATK Network (AS{{ .Site.Data.config.asn }}) is a global DN42 Network, with network presence on nearly every continent.</p>
</div>

<div class="container-fluid">
    <div id="map" style="width: 80%;"></div>

    <br />
    <br />

    <h2 align="center">Network Nodes</h2>

    <br />

    <div class="node-table" align="center">

        <table class="table table-bordered table-striped table-hover" style="width: 80%;" id="peerTable">
            <thead>
                <tr>
                    <th scope="col">Node ID</th>
                    <th scope="col">Hostname</th>
                    <th scope="col">Location</th>
                    <th scope="col">Peers</th>
                    <th scope="col">Supported Protocols</th>
                    <th scope="col">Peering Policy</th>
                    <th scope="col">Peering Method</th>
                </tr>
            </thead>
            <tbody>
                {{- $regionsSlice := slice -}}
                {{- range $key, $value := .Site.Data.config.regions }}
                {{- $regionsSlice = $regionsSlice | append (dict "Key" $key "Value" $value) -}}
                {{- end }}
                
                {{- $sortedRegions := sort $regionsSlice "Value.sort" "asc" -}}
                
                {{- range $regionEntry := $sortedRegions }}
                {{- $region := $regionEntry.Key -}}
                {{- $hosts := $regionEntry.Value.hosts -}}
                
                {{- $hostSlice := slice -}}
                {{- range $host, $data := $hosts }}
                {{- $hostSlice = $hostSlice | append (dict "name" $host "data" $data) -}}
                {{- end }}
                
                {{- $sortedHosts := sort $hostSlice "name" "asc" -}}
                
                {{- range $hostEntry := $sortedHosts }}
                {{- $host := $hostEntry.name -}}
                {{- $data := $hostEntry.data -}}
                
                <tr id="{{ $host }}" class="node">
                    <th scope="row"><a href="/nodes#{{ $host }}">{{ $host }}</a></th>
                    <td>{{ $data.hostname }}</td>
                    <td>{{ $data.location }}</td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
                
                {{- end }}
                
                {{- end }}
            </tbody>
        </table>

    </div>

    <br />

    <h2 align="center">Network Size</h2>
    
    <div align="center">
        <small>Thanks <a href="https://github.com/jlu5/ansible-dn42">@jlu5</a> for the inspiration for the graph</small>

        <img src="/images/history.svg" alt="Network Size Graph" style="width: 40%; height: auto; display: block;">
    </div>
</div>

{{ end }}


{{ define "footer-scripts" }}
<script>

    var hostGeoJson = {{ .Site.Data.hosts }}

    var map = L.map('map', {
        center: [20, -5],
        zoom: 3,
        minZoom: 3
    });

    var layerGroup = L.geoJSON(hostGeoJson, {
        style: {
            "color": "#7393B3",
            "weight": 0,
            "dashArray": '5, 5',
        },
        onEachFeature: function (feature, layer) {
            layer.bindPopup(feature.properties.title);
        }
    }).addTo(map);

    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
    }).addTo(map);

</script>

<script>
    const protocolClassMap = {
        wireguard: "badge-info",
        openvpn: "badge-secondary",
        default: "badge-primary"
    };
    
    var xmlHttp = new XMLHttpRequest();
    var table = document.getElementById('peerTable');
    var rows = table.getElementsByClassName("node");

    for (var i = 0; i < rows.length; i++) {
        console.log("Fetching data for row " + i + ": " + rows[i].children[1].innerText);
        var url = "https://" + rows[i].children[1].innerText + "/api/meta/info";
        try {
            xmlHttp.open("GET", url, false);
            xmlHttp.send(null);

            if (xmlHttp.status === 200) {
                var response = JSON.parse(xmlHttp.responseText);

                // Fill current peers / peer limit
                rows[i].children[3].innerText = response.current_peers + " / " + response.peer_limit;

                // Add enabled protocol pills to the 5th column (index 4)
                var protocolCell = rows[i].children[4];
                protocolCell.innerHTML = ""; // Clear previous content if any

                for (var protocol in response.protocols) {
                    if (response.protocols[protocol].enabled) {
                        var badgeClass = protocolClassMap[protocol] || protocolClassMap.default;
                        var span = document.createElement("span");
                        span.className = "badge " + badgeClass + " rounded-pill me-1";
                        span.textContent = protocol.charAt(0).toUpperCase() + protocol.slice(1);
                        protocolCell.appendChild(span);
                    }
                }

                // Add peering status pills to the 6th column (index 5)
                var statusCell = rows[i].children[5];
                statusCell.innerHTML = ""; // Clear previous content if any

                if (response.peering_policy = "Open") {
                    var span = document.createElement("span");
                    span.className = "badge badge-success rounded-pill me-1";
                    span.textContent = "Open";
                    statusCell.appendChild(span);
                } else if (response.peering_policy = "Closed") {
                    var span = document.createElement("span");
                    span.className = "badge badge-danger rounded-pill me-1";
                    span.textContent = "Closed";
                    statusCell.appendChild(span);
                } else {
                    console.warn("Unknown peering policy for " + rows[i].children[1].innerText + ": " + response.peering_policy);
                }

                // Add peering method pills to the 7th column (index 6)
                var methodCell = rows[i].children[6];
                methodCell.innerHTML = ""; // Clear previous content if any

                if (response.peering_method = "Manual") {
                    var span = document.createElement("a");
                    span.className = "badge badge-warning rounded-pill me-1";
                    span.textContent = "Manual, please get in touch";
                    span.href = "/contact";
                    methodCell.appendChild(span);
                } else if (response.peering_method = "Automatic") {
                    var span = document.createElement("a");
                    span.className = "badge badge-success rounded-pill me-1";
                    span.textContent = "Automatic";
                    methodCell.appendChild(span);
                } else {
                    console.warn("Unknown peering method for " + rows[i].children[1].innerText + ": " + response.peering_method);
                }

            } else {
                console.error("Failed to fetch data for " + url + ": Status " + xmlHttp.status);
                continue;
            }
        } catch (e) {
            console.error("Error fetching data for " + url + ": " + e);
            continue;
        }
    }

</script>
{{ end }}